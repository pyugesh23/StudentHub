<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDF Preview - {{ title }}</title>
    <!-- Same fonts as base.html and editor.html -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=Outfit:wght@300;400;500;600;700;800;900&display=swap"
        rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
        body {
            margin: 0;
            padding: 0;
            background-color: #f0f2f5;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
            font-family: 'Inter', sans-serif;
        }

        .preview-container {
            background-color: white;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            margin: 40px auto;
            display: block;
            width: 210mm;
            min-height: auto;
        }

        /* Overlay for loading */
        #loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(15, 23, 42, 0.9);
            color: white;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 5px solid rgba(255, 255, 255, 0.1);
            border-top-color: #388bfd;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }
    </style>
</head>

<body>
    <div id="loading-overlay">
        <div class="spinner"></div>
        <h2>Generating Your PDF...</h2>
        <p>This will take just a moment.</p>
    </div>

    <div id="resume-content" class="preview-container">
        {% include template_layout %}
    </div>

    <script>
        async function generatePDF() {
            const sourceElement = document.getElementById('resume-content');
            const filename = "{{ title }}".replace(/\s+/g, '_') + '.pdf';

            try {
                // 1. Wait for images and fonts
                const images = sourceElement.getElementsByTagName('img');
                const fontPromise = document.fonts ? document.fonts.ready : Promise.resolve();

                await Promise.all([
                    fontPromise,
                    ...Array.from(images).map(img => {
                        if (img.complete) return Promise.resolve();
                        return new Promise(resolve => {
                            img.onload = resolve;
                            img.onerror = resolve;
                        });
                    })
                ]);

                // 2. Setup options
                const opt = {
                    margin: 0,
                    filename: filename,
                    image: { type: 'jpeg', quality: 0.98 },
                    html2canvas: {
                        scale: 2,
                        useCORS: true,
                        letterRendering: true
                    },
                    jsPDF: {
                        unit: 'mm',
                        format: 'a4',
                        orientation: 'portrait'
                    }
                };

                // Wait for layout to settle
                await new Promise(resolve => setTimeout(resolve, 500));

                // Generate and save
                await html2pdf().from(sourceElement).set(opt).save();

                // 3. Show Completion (Only for Preview mode)
                setTimeout(() => {
                    document.getElementById('loading-overlay').innerHTML = `
                            <h2 style="color: #10b981;">Download Complete!</h2>
                            <p>You can now close this tab.</p>
                            <button onclick="window.close()" style="background: #388bfd; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; margin-top: 10px;">Close Window</button>
                        `;
                }, 1000);

            } catch (err) {
                console.error("PDF Generation Error:", err);
                document.getElementById('loading-overlay').innerHTML = `
                        <h2 style="color: #ef4444;">Generation Failed</h2>
                        <p>There was an error generating your PDF. Please try again from the editor.</p>
                        <button onclick="window.history.back()" style="background: #388bfd; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; margin-top: 10px;">Go Back</button>
                    `;
            }
        }

        // Run on load
        window.onload = generatePDF;
    </script>
</body>

</html>