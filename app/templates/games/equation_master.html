{% extends "base.html" %}

{% block title %}Equation Master{% endblock %}

{% block container_class %}container mt-2{% endblock %}

{% block content %}
<style>
    body {
        background: #020617;
        background-image:
            radial-gradient(at 0% 0%, hsla(253, 16%, 7%, 1) 0, transparent 50%),
            radial-gradient(at 50% 0%, hsla(225, 39%, 30%, 1) 0, transparent 50%);
        color: white;
    }

    .game-container {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 1.5rem;
        padding: 1rem 2rem;
        max-width: 900px;
        margin: 0 auto;
    }

    .game-header {
        text-align: center;
        margin-bottom: 2rem;
    }

    .game-title {
        font-family: 'Outfit', sans-serif;
        font-size: 2.8rem;
        font-weight: 800;
        background: linear-gradient(to right, #fff, #ff7b72);
        -webkit-background-clip: text;
        background-clip: text;
        -webkit-text-fill-color: transparent;
        margin-bottom: 0.2rem;
    }

    .game-stats {
        display: flex;
        gap: 2rem;
        color: #94a3b8;
        font-weight: 600;
        font-size: 1.2rem;
    }

    .equation-display {
        background: rgba(255, 255, 255, 0.05);
        padding: 2.5rem 3rem;
        border-radius: 24px;
        border: 1px solid rgba(255, 255, 255, 0.1);
        display: flex;
        align-items: center;
        gap: 1rem;
        font-size: 3rem;
        font-family: 'Outfit', sans-serif;
        font-weight: 700;
        margin-bottom: 2rem;
        box-shadow: 0 0 50px rgba(255, 123, 114, 0.05);
    }

    .blank {
        width: 80px;
        height: 100px;
        background: #1e293b;
        border: 2px solid rgba(255, 255, 255, 0.2);
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.2s;
        color: #ff7b72;
    }

    .blank.active {
        border-color: #ff7b72;
        background: rgba(255, 123, 114, 0.1);
    }

    .blank.filled {
        border-color: rgba(255, 255, 255, 0.3);
    }

    .op {
        color: #94a3b8;
    }

    .target-val {
        color: #fff;
    }

    .keypad {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 1rem;
        max-width: 300px;
    }

    .key {
        width: 80px;
        height: 80px;
        background: #1e293b;
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 16px;
        font-size: 1.8rem;
        font-weight: 700;
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.2s;
    }

    .key:hover {
        background: #334155;
        transform: scale(1.05);
    }

    .key:active {
        transform: scale(0.95);
    }

    .key.special {
        color: #ff7b72;
    }

    .key.wide {
        grid-column: span 3;
        width: 100%;
        height: 60px;
    }

    .controls {
        display: flex;
        gap: 1rem;
        margin-top: 2rem;
    }

    .btn-game {
        padding: 0.75rem 1.75rem;
        border-radius: 12px;
        border: none;
        font-weight: 700;
        cursor: pointer;
        transition: all 0.2s;
        text-transform: uppercase;
        letter-spacing: 1px;
    }

    .btn-primary {
        background: #ff7b72;
        color: #020617;
    }

    .btn-outline {
        background: rgba(255, 255, 255, 0.1);
        color: white;
        text-decoration: none;
    }

    .toast {
        position: fixed;
        bottom: 2rem;
        left: 50%;
        transform: translateX(-50%);
        background: #1e293b;
        color: #ff7b72;
        padding: 1rem 2rem;
        border-radius: 12px;
        border: 1px solid #ff7b72;
        font-weight: 700;
        display: none;
        z-index: 1000;
    }

    @media (max-width: 600px) {
        .equation-display {
            font-size: 1.8rem;
            padding: 1.5rem;
            gap: 0.5rem;
        }

        .blank {
            width: 50px;
            height: 70px;
        }

        .key {
            width: 60px;
            height: 60px;
            font-size: 1.4rem;
        }

        .keypad {
            max-width: 200px;
        }
    }
</style>

<div class="game-container">
    <div class="game-header">
        <h1 class="game-title">Equation Master</h1>
        <div class="game-stats">
            <span>Level: <span id="level">1</span></span>
            <span>Solved: <span id="solved">0</span></span>
        </div>
    </div>

    <div class="equation-display" id="equation">
        <!-- Generated by JS -->
    </div>

    <div class="keypad">
        <div class="key" onclick="pressKey(1)">1</div>
        <div class="key" onclick="pressKey(2)">2</div>
        <div class="key" onclick="pressKey(3)">3</div>
        <div class="key" onclick="pressKey(4)">4</div>
        <div class="key" onclick="pressKey(5)">5</div>
        <div class="key" onclick="pressKey(6)">6</div>
        <div class="key" onclick="pressKey(7)">7</div>
        <div class="key" onclick="pressKey(8)">8</div>
        <div class="key" onclick="pressKey(9)">9</div>
        <div></div>
        <div class="key" onclick="pressKey(0)">0</div>
        <div class="key special" onclick="pressKey('DEL')"><i class="fas fa-backspace"></i></div>
    </div>

    <div class="controls">
        <button class="btn-game btn-primary" onclick="checkSolution()">Check Answer</button>
        <a href="{{ url_for('games.hub') }}" class="btn-game btn-outline">Back to Hub</a>
    </div>
</div>

<div class="toast" id="toast">Incorrect! Try again.</div>

<script>
    let level = 1;
    let solved = 0;
    let currentEquation = {
        a: 0, b: 0, c: 0,
        op1: 'x', op2: '+',
        target: 20
    };
    let activeBlankIdx = 0;
    let userInputs = ["", "", ""];

    function initGame() {
        generateEquation();
        renderEquation();
    }

    function generateEquation() {
        userInputs = ["", "", ""];
        activeBlankIdx = 0;

        let a, b, c, target;
        const maxVal = 5 + level;

        // Patterns: 
        // 1: (a * b) + c = target
        // 2: (a + b) * c = target
        // 3: (a * b) - c = target
        const pattern = Math.floor(Math.random() * 3) + 1;

        if (pattern === 1) {
            a = Math.floor(Math.random() * maxVal) + 2;
            b = Math.floor(Math.random() * maxVal) + 2;
            c = Math.floor(Math.random() * (maxVal * 2)) + 1;
            target = (a * b) + c;
            currentEquation = { a, b, c, op1: '×', op2: '+', target, pattern };
        } else if (pattern === 2) {
            a = Math.floor(Math.random() * maxVal) + 1;
            b = Math.floor(Math.random() * maxVal) + 1;
            c = Math.floor(Math.random() * (maxVal / 2)) + 2;
            target = (a + b) * c;
            currentEquation = { a, b, c, op1: '+', op2: '×', target, pattern };
        } else {
            a = Math.floor(Math.random() * maxVal) + 2;
            b = Math.floor(Math.random() * maxVal) + 2;
            c = Math.floor(Math.random() * (a * b - 1)) + 1;
            target = (a * b) - c;
            currentEquation = { a, b, c, op1: '×', op2: '-', target, pattern };
        }
    }

    function renderEquation() {
        const eqDiv = document.getElementById('equation');
        eqDiv.innerHTML = '';

        if (currentEquation.pattern === 2) eqDiv.innerHTML += '<span class="op">(</span>';

        createBlank(eqDiv, 0);
        eqDiv.innerHTML += `<span class="op">${currentEquation.op1}</span>`;
        createBlank(eqDiv, 1);

        if (currentEquation.pattern === 2) eqDiv.innerHTML += '<span class="op">)</span>';

        eqDiv.innerHTML += `<span class="op">${currentEquation.op2}</span>`;
        createBlank(eqDiv, 2);

        eqDiv.innerHTML += '<span class="op">=</span>';
        eqDiv.innerHTML += `<span class="target-val">${currentEquation.target}</span>`;
    }

    function createBlank(container, idx) {
        const div = document.createElement('div');
        div.className = 'blank' + (idx === activeBlankIdx ? ' active' : '') + (userInputs[idx] !== "" ? ' filled' : '');
        div.innerText = userInputs[idx];
        div.onclick = () => { activeBlankIdx = idx; renderEquation(); };
        container.appendChild(div);
    }

    function pressKey(key) {
        if (key === 'DEL') {
            userInputs[activeBlankIdx] = userInputs[activeBlankIdx].slice(0, -1);
        } else {
            if (userInputs[activeBlankIdx].length < 2) {
                userInputs[activeBlankIdx] += key;
            }
        }
        renderEquation();
    }

    function checkSolution() {
        const [uA, uB, uC] = userInputs.map(v => parseInt(v));
        if (isNaN(uA) || isNaN(uB) || isNaN(uC)) return showToast("Fill all blanks!");

        let result;
        if (currentEquation.pattern === 1) result = (uA * uB) + uC;
        else if (currentEquation.pattern === 2) result = (uA + uB) * uC;
        else result = (uA * uB) - uC;

        if (result === currentEquation.target) {
            solved++;
            document.getElementById('solved').innerText = solved;
            if (solved % 5 === 0) {
                level++;
                document.getElementById('level').innerText = level;
            }
            showToast("Correct! Next one...", true);
            setTimeout(() => {
                initGame();
            }, 1000);
        } else {
            showToast("Incorrect result: " + result);
        }
    }

    function showToast(msg, success = false) {
        const toast = document.getElementById('toast');
        toast.innerText = msg;
        toast.style.color = success ? '#7ee787' : '#ff7b72';
        toast.style.borderColor = success ? '#7ee787' : '#ff7b72';
        toast.style.display = 'block';
        setTimeout(() => toast.style.display = 'none', 1500);
    }

    // Handle Keyboard Support
    window.addEventListener('keydown', (e) => {
        if (e.key >= '0' && e.key <= '9') pressKey(e.key);
        if (e.key === 'Backspace') pressKey('DEL');
        if (e.key === 'Enter') checkSolution();
        if (e.key === 'Tab') {
            e.preventDefault();
            activeBlankIdx = (activeBlankIdx + 1) % 3;
            renderEquation();
        }
    });

    initGame();
</script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
{% endblock %}