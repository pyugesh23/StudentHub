{% extends "base.html" %}

{% block title %}Puzzle Blocks{% endblock %}

{% block container_class %}container mt-2{% endblock %}

{% block content %}
<style>
    body {
        background: #020617;
        background-image:
            radial-gradient(at 0% 0%, hsla(253, 16%, 7%, 1) 0, transparent 50%),
            radial-gradient(at 50% 0%, hsla(225, 39%, 30%, 1) 0, transparent 50%);
        color: white;
    }

    .game-container {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 1rem;
        padding: 0.5rem 2rem;
        max-width: 800px;
        margin: 0 auto;
    }

    .puzzle-header {
        text-align: center;
    }

    .puzzle-title {
        font-family: 'Outfit', sans-serif;
        font-size: 2.5rem;
        font-weight: 800;
        background: linear-gradient(to right, #60a5fa, #388bfd);
        -webkit-background-clip: text;
        background-clip: text;
        -webkit-text-fill-color: transparent;
        margin-bottom: 0.5rem;
    }

    .stats {
        display: flex;
        gap: 2rem;
        color: #94a3b8;
        font-weight: 600;
        font-size: 1.1rem;
    }

    .puzzle-board {
        display: grid;
        grid-template-columns: repeat(3, 100px);
        grid-template-rows: repeat(3, 100px);
        gap: 10px;
        background: rgba(30, 41, 59, 0.5);
        padding: 10px;
        border-radius: 12px;
        border: 2px solid rgba(255, 255, 255, 0.1);
    }

    .tile {
        width: 100px;
        height: 100px;
        background: #388bfd;
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 2rem;
        font-weight: 800;
        border-radius: 8px;
        cursor: pointer;
        transition: transform 0.1s, background-color 0.2s;
        user-select: none;
    }

    .tile:hover {
        background: #60a5fa;
    }

    .empty {
        background: transparent;
        cursor: default;
    }

    .empty:hover {
        background: transparent;
    }

    .controls {
        display: flex;
        gap: 1rem;
    }

    .btn-game {
        padding: 0.75rem 2rem;
        border-radius: 12px;
        border: none;
        font-weight: 700;
        cursor: pointer;
        transition: all 0.2s;
        text-transform: uppercase;
        letter-spacing: 1px;
    }

    .btn-primary {
        background: #388bfd;
        color: white;
    }

    .btn-primary:hover {
        filter: brightness(1.1);
        transform: translateY(-2px);
    }

    .win-message {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: rgba(15, 23, 42, 0.95);
        padding: 3rem;
        border-radius: 24px;
        border: 2px solid #388bfd;
        text-align: center;
        display: none;
        z-index: 100;
        backdrop-filter: blur(10px);
    }
</style>

<div class="game-container">
    <div class="puzzle-header">
        <h1 class="puzzle-title">Puzzle Blocks</h1>
        <div class="stats">
            <span>Moves: <span id="moveCount">0</span></span>
            <span>Time: <span id="timeCount">00:00</span></span>
        </div>
    </div>

    <div class="puzzle-board" id="board">
        <!-- Tiles will be generated here -->
    </div>

    <div class="controls">
        <button class="btn-game btn-primary" onclick="shuffleGame()">Shuffle</button>
        <a href="{{ url_for('games.hub') }}" class="btn-game"
            style="background: rgba(255,255,255,0.1); color: white; text-decoration: none;">Back to Hub</a>
    </div>
</div>

<div class="win-message" id="winMessage">
    <h2 style="font-size: 2.5rem; margin-bottom: 1rem;">ðŸŽ‰ You Win!</h2>
    <p style="color: #94a3b8; margin-bottom: 2rem;">Total Moves: <span id="finalMoves">0</span><br>Time Taken: <span
            id="finalTime">00:00</span></p>
    <button class="btn-game btn-primary" onclick="resetGame()">Play Again</button>
</div>

<script>
    let tiles = [1, 2, 3, 4, 5, 6, 7, 8, null];
    let moveCount = 0;
    let seconds = 0;
    let timerInterval;
    let isGameOver = false;

    const board = document.getElementById('board');
    const moveDisplay = document.getElementById('moveCount');
    const timeDisplay = document.getElementById('timeCount');
    const winMessage = document.getElementById('winMessage');

    function createBoard() {
        board.innerHTML = '';
        tiles.forEach((tile, index) => {
            const div = document.createElement('div');
            div.className = `tile ${tile === null ? 'empty' : ''}`;
            div.textContent = tile || '';
            div.onclick = () => moveTile(index);
            board.appendChild(div);
        });
    }

    function moveTile(index) {
        if (isGameOver) return;

        const emptyIndex = tiles.indexOf(null);
        if (isAdjacent(index, emptyIndex)) {
            swapTiles(index, emptyIndex);
            moveCount++;
            moveDisplay.textContent = moveCount;
            createBoard();
            checkWin();
        }
    }

    function isAdjacent(idx1, idx2) {
        const r1 = Math.floor(idx1 / 3);
        const c1 = idx1 % 3;
        const r2 = Math.floor(idx2 / 3);
        const c2 = idx2 % 3;
        return (Math.abs(r1 - r2) + Math.abs(c1 - c2)) === 1;
    }

    function swapTiles(idx1, idx2) {
        [tiles[idx1], tiles[idx2]] = [tiles[idx2], tiles[idx1]];
    }

    function shuffleGame() {
        if (!timerInterval) startTimer();

        // Accurate shuffle to ensure solvability
        for (let i = 0; i < 200; i++) {
            const emptyIndex = tiles.indexOf(null);
            const adjacents = [];
            if (emptyIndex % 3 > 0) adjacents.push(emptyIndex - 1); // left
            if (emptyIndex % 3 < 2) adjacents.push(emptyIndex + 1); // right
            if (emptyIndex >= 3) adjacents.push(emptyIndex - 3); // top
            if (emptyIndex < 6) adjacents.push(emptyIndex + 3); // bottom

            const randomAdj = adjacents[Math.floor(Math.random() * adjacents.length)];
            swapTiles(emptyIndex, randomAdj);
        }

        moveCount = 0;
        moveDisplay.textContent = moveCount;
        isGameOver = false;
        winMessage.style.display = 'none';
        createBoard();
    }

    function startTimer() {
        seconds = 0;
        clearInterval(timerInterval);
        timerInterval = setInterval(() => {
            seconds++;
            const mins = Math.floor(seconds / 60).toString().padStart(2, '0');
            const secs = (seconds % 60).toString().padStart(2, '0');
            timeDisplay.textContent = `${mins}:${secs}`;
        }, 1000);
    }

    function checkWin() {
        const winState = [1, 2, 3, 4, 5, 6, 7, 8, null];
        const isWin = tiles.every((tile, index) => tile === winState[index]);

        if (isWin && moveCount > 0) {
            isGameOver = true;
            clearInterval(timerInterval);
            document.getElementById('finalMoves').textContent = moveCount;
            document.getElementById('finalTime').textContent = timeDisplay.textContent;
            winMessage.style.display = 'block';
        }
    }

    function resetGame() {
        tiles = [1, 2, 3, 4, 5, 6, 7, 8, null];
        moveCount = 0;
        seconds = 0;
        moveDisplay.textContent = '0';
        timeDisplay.textContent = '00:00';
        clearInterval(timerInterval);
        timerInterval = null;
        isGameOver = false;
        winMessage.style.display = 'none';
        createBoard();
    }

    createBoard();
</script>
{% endblock %}