{% extends "base.html" %}

{% block title %}Professional Online Compiler{% endblock %}

{% block container_class %}{% endblock %}

{% block content %}
<div class="compiler-page-wrapper">
    <!-- Navbar / Header -->
    <header class="compiler-header">
        <div class="header-left">
            <h5 class="m-0"><i class="fas fa-terminal"></i> StudentHub IDE</h5>
        </div>

        <div class="header-actions">
            <!-- Language Selection -->
            <div class="select-group">
                <i class="fas fa-code"></i>
                <select id="language-select" class="custom-select-ide">
                    <option value="python" selected>python</option>
                    <option value="c">c</option>
                    <option value="cpp">c++</option>
                    <option value="java">java</option>
                    <option value="javascript">javascript</option>
                </select>
            </div>

            <button id="theme-btn" class="icon-btn-ide" title="Toggle Light/Dark Mode">
                <i class="fas fa-moon"></i>
            </button>
            <button id="fullscreen-btn" class="icon-btn-ide" title="Toggle Fullscreen">
                <i class="fas fa-expand"></i>
            </button>

            <button id="run-btn" class="run-btn-premium">
                <i class="fas fa-play"></i> <span>Run Code</span>
                <div class="btn-spinner" id="btn-spinner"></div>
            </button>
        </div>
    </header>

    <main class="ide-main-container">
        <!-- Editor Section -->
        <div class="editor-section">
            <div id="ace-editor"></div>
        </div>

        <!-- Sidebar / Results Section -->
        <aside class="ide-sidebar">
            <!-- Execution Results Area -->
            <div class="sidebar-panel result-panel">
                <div class="panel-header">
                    <i class="fas fa-poll-h"></i> <span>Execution Result</span>
                    <button class="clear-btn" id="clear-output"><i class="fas fa-eraser"></i></button>
                </div>

                <div class="metadata-bar" id="metadata-bar" style="display: none;">
                    <span class="meta-item"><i class="fas fa-clock"></i> <span id="meta-time">0</span> ms</span>
                    <span class="meta-item"><i class="fas fa-memory"></i> <span id="meta-memory">0</span> KB</span>
                    <span class="meta-item status-badge" id="meta-status">Accepted</span>
                </div>

                <div class="result-display" id="result-display">
                    <p class="placeholder-text">Click "Run Code" to see results.</p>
                </div>
            </div>

            <!-- Custom Input Area -->
            <div class="sidebar-panel input-panel-bottom">
                <div class="panel-header">
                    <i class="fas fa-keyboard"></i> <span>Custom Input (stdin)</span>
                </div>
                <div style="flex: 1; display: flex;">
                    <textarea id="stdin-input" placeholder="Enter input here (one per line)..."
                        style="width: 100%;"></textarea>
                </div>
            </div>
        </aside>
    </main>
</div>

<!-- Ace Editor & FontAwesome -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.23.0/ace.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

<style>
    :root {
        --ide-bg: #0d1117;
        --ide-header: #161b22;
        --ide-border: #30363d;
        --ide-text: #c9d1d9;
        --ide-accent: #238636;
        --ide-accent-hover: #2ea043;
        --panel-bg: #0d1117;
        --header-text: #fff;
    }

    [data-theme="light"] {
        --ide-bg: #ffffff;
        --ide-header: #f6f8fa;
        --ide-border: #d0d7de;
        --ide-text: #24292f;
        --ide-accent: #2da44e;
        --ide-accent-hover: #2c974b;
        --panel-bg: #ffffff;
        --header-text: #24292f;
    }

    body {
        margin: 0;
        background: var(--ide-bg);
        overflow: hidden;
    }

    .navbar {
        margin-bottom: 0 !important;
    }

    .compiler-page-wrapper {
        display: flex;
        flex-direction: column;
        height: calc(100vh - 72px);
        color: var(--ide-text);
        font-family: 'Inter', system-ui, -apple-system, sans-serif;
        background: var(--ide-bg);
    }

    .compiler-page-wrapper:fullscreen {
        height: 100vh;
    }

    .icon-btn-ide {
        background: #21262d;
        color: #8b949e;
        border: 1px solid var(--ide-border);
        padding: 8px;
        width: 38px;
        height: 38px;
        border-radius: 6px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s;
        font-size: 1.1rem;
    }

    [data-theme="light"] .icon-btn-ide {
        background: #f6f8fa;
        color: #57606a;
    }

    .icon-btn-ide:hover {
        color: #fff;
        background: #30363d;
        border-color: #8b949e;
        transform: translateY(-1px);
    }

    [data-theme="light"] .icon-btn-ide:hover {
        color: #24292f;
        background: #ebeff2;
        border-color: #afb8c1;
    }

    /* Header Styling */
    .compiler-header {
        background: var(--ide-header);
        border-bottom: 1px solid var(--ide-border);
        padding: 10px 24px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        z-index: 100;
        color: var(--header-text);
    }

    .header-actions {
        display: flex;
        gap: 20px;
        align-items: center;
    }

    .custom-select-ide {
        background: #21262d;
        color: #fff;
        border: 1px solid var(--ide-border);
        padding: 8px 16px;
        border-radius: 6px;
        outline: none;
        cursor: pointer;
        font-size: 0.9rem;
    }

    .run-btn-premium {
        background: var(--ide-accent);
        color: white;
        border: none;
        padding: 8px 24px;
        border-radius: 6px;
        font-weight: 700;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 10px;
        transition: all 0.2s;
        position: relative;
    }

    .run-btn-premium:hover {
        background: var(--ide-accent-hover);
        transform: translateY(-1px);
    }

    .run-btn-premium:active {
        transform: translateY(0);
    }

    /* Main Container */
    .ide-main-container {
        display: grid;
        grid-template-columns: 1fr 500px;
        /* Increased to 500px */
        flex: 1;
        overflow: hidden;
    }

    /* Editor */
    .editor-section {
        position: relative;
        border-right: 1px solid var(--ide-border);
    }

    #ace-editor {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        font-size: 15px;
    }

    /* Sidebar */
    .ide-sidebar {
        background: var(--ide-header);
        display: flex;
        flex-direction: column;
        overflow-y: hidden;
    }

    .sidebar-panel {
        display: flex;
        flex-direction: column;
        padding: 12px 24px;
        /* Reduced vertical padding from 24px to 12px */
    }

    .result-panel {
        flex: 2;
        /* 70% distribution */
        border-bottom: 1px solid var(--ide-border);
        overflow-y: auto;
        min-height: 0;
    }

    .input-panel-bottom {
        flex: 3;
        /* 30% */
        background: var(--ide-header);
        overflow: hidden;
        display: flex;
        flex-direction: column;
        min-height: 0;
    }

    .panel-header {
        font-size: 0.8rem;
        text-transform: uppercase;
        letter-spacing: 1px;
        font-weight: 700;
        color: #8b949e;
        margin-bottom: 8px;
        /* Reduced from 15px */
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    #stdin-input {
        background: var(--panel-bg);
        color: var(--ide-text);
        border: 1px solid var(--ide-border);
        border-radius: 6px;
        padding: 12px;
        flex: 1;
        resize: none;
        font-family: monospace;
        font-size: 0.9rem;
        outline: none;
    }

    #stdin-input:focus {
        border-color: #58a6ff;
    }

    /* Result Display */
    .result-display {
        font-family: 'JetBrains Mono', 'Fira Code', monospace;
        font-size: 1rem;
        line-height: 1.6;
        white-space: pre-wrap;
        word-break: break-all;
    }

    .placeholder-text {
        color: #484f58;
        font-style: italic;
    }

    .metadata-bar {
        display: flex;
        gap: 15px;
        margin-bottom: 10px;
        /* Reduced from 15px */
        padding: 8px 12px;
        background: var(--ide-header);
        border: 1px solid var(--ide-border);
        border-radius: 6px;
        font-size: 0.75rem;
        align-items: center;
    }

    .status-badge {
        margin-left: auto;
        padding: 2px 8px;
        border-radius: 4px;
        background: #238636;
        color: #fff;
        font-weight: 700;
    }

    .status-badge.error {
        background: #da3633;
    }

    .text-success {
        color: #3fb950;
    }

    .text-danger {
        color: #f85149;
    }

    .text-warning {
        color: #d29922;
    }

    /* Spinner */
    .btn-spinner {
        width: 16px;
        height: 16px;
        border: 2px solid rgba(255, 255, 255, 0.3);
        border-top-color: #fff;
        border-radius: 50%;
        animation: spin 0.8s linear infinite;
        display: none;
    }

    @keyframes spin {
        to {
            transform: rotate(360deg);
        }
    }

    .running .btn-spinner {
        display: block;
    }

    .running i {
        display: none;
    }

    .running {
        opacity: 0.7;
        pointer-events: none;
    }

    .clear-btn {
        background: none;
        border: none;
        color: #8b949e;
        cursor: pointer;
        transition: color 0.2s;
    }

    .clear-btn:hover {
        color: #fff;
    }

    @media (max-width: 1024px) {
        .ide-main-container {
            grid-template-columns: 1fr;
        }

        .ide-sidebar {
            height: 400px;
            border-top: 1px solid var(--ide-border);
        }
    }
</style>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        // Initialize Editor
        const editor = ace.edit("ace-editor");
        editor.setTheme("ace/theme/one_dark");
        editor.setShowPrintMargin(false);

        const boilerplate = {
            python: 'print("Hello, StudentHub!")\n# Try adding input():\n# name = input()\n# print(f"Hello, {name}")',
            c: '#include <stdio.h>\n\nint main() {\n    printf("Hello, StudentHub!\\n");\n    return 0;\n}',
            cpp: '#include <iostream>\n\nint main() {\n    std::cout << "Hello, StudentHub!" << std::endl;\n    return 0;\n}',
            java: 'public class Main {\n    public static void main(String[] args) {\n        System.out.println("Hello, StudentHub!");\n    }\n}',
            javascript: 'console.log("Hello, StudentHub!");'
        };

        const modes = {
            python: 'ace/mode/python',
            c: 'ace/mode/c_cpp',
            cpp: 'ace/mode/c_cpp',
            java: 'ace/mode/java',
            javascript: 'ace/mode/javascript'
        };

        // UI Elements
        const runBtn = document.getElementById('run-btn');
        const themeBtn = document.getElementById('theme-btn');
        const fullscreenBtn = document.getElementById('fullscreen-btn');
        const langSelect = document.getElementById('language-select');
        const stdinInput = document.getElementById('stdin-input');
        const resultDisplay = document.getElementById('result-display');
        const metadataBar = document.getElementById('metadata-bar');
        const metaTime = document.getElementById('meta-time');
        const metaMemory = document.getElementById('meta-memory');
        const metaStatus = document.getElementById('meta-status');

        // Theme Logic
        const applyTheme = (theme) => {
            document.documentElement.setAttribute('data-theme', theme);
            localStorage.setItem('ide-theme', theme);
            const aceTheme = theme === 'light' ? 'ace/theme/chrome' : 'ace/theme/one_dark';
            editor.setTheme(aceTheme);
            themeBtn.innerHTML = theme === 'light' ? '<i class="fas fa-sun"></i>' : '<i class="fas fa-moon"></i>';
        };

        const currentTheme = localStorage.getItem('ide-theme') || 'dark';
        applyTheme(currentTheme);

        themeBtn.onclick = () => {
            const newTheme = document.documentElement.getAttribute('data-theme') === 'dark' ? 'light' : 'dark';
            applyTheme(newTheme);
        };

        // Fullscreen Logic
        fullscreenBtn.onclick = () => {
            const ide = document.querySelector('.compiler-page-wrapper');
            if (!document.fullscreenElement) {
                ide.requestFullscreen().catch(err => {
                    console.error(`Error attempting to enable fullscreen: ${err.message}`);
                });
                fullscreenBtn.innerHTML = '<i class="fas fa-compress"></i>';
            } else {
                document.exitFullscreen();
                fullscreenBtn.innerHTML = '<i class="fas fa-expand"></i>';
            }
        };

        // Sync icon on exit
        document.addEventListener('fullscreenchange', () => {
            if (!document.fullscreenElement) {
                fullscreenBtn.innerHTML = '<i class="fas fa-expand"></i>';
            }
        });

        // Setup Init
        const setLanguage = (lang) => {
            editor.session.setMode(modes[lang]);
            const saved = localStorage.getItem(`code_${lang}`);
            editor.setValue(saved || boilerplate[lang], -1);
        };

        setLanguage(langSelect.value);

        langSelect.onchange = (e) => {
            localStorage.setItem(`code_${e.target.previousValue || 'python'}`, editor.getValue());
            setLanguage(e.target.value);
            e.target.previousValue = e.target.value;
        };

        // AJAX Execution
        runBtn.onclick = async () => {
            runBtn.classList.add('running');
            resultDisplay.innerHTML = '<p class="text-warning">Running execution...</p>';
            metadataBar.style.display = 'none';

            const payload = {
                source_code: editor.getValue(),
                language: langSelect.value,
                stdin: stdinInput.value
            };

            try {
                const response = await fetch('/compiler/run', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const data = await response.json();

                if (data.error) {
                    resultDisplay.innerHTML = `<pre class="text-danger">${data.error}</pre>`;
                } else {
                    // Success logic
                    let finalOutput = '';
                    if (data.compile_output) finalOutput += `<span class="text-danger">${data.compile_output}</span>\n`;
                    if (data.stderr) finalOutput += `<span class="text-danger">${data.stderr}</span>\n`;
                    if (data.stdout) finalOutput += `<span class="text-success">${data.stdout}</span>`;

                    if (!finalOutput) finalOutput = '<p class="placeholder-text">Program executed with no output.</p>';

                    resultDisplay.innerHTML = finalOutput;

                    // Metadata update
                    metaTime.textContent = (parseFloat(data.time || 0) * 1000).toFixed(0);
                    metaMemory.textContent = data.memory || 0;
                    metaStatus.textContent = data.status;
                    metaStatus.className = `status-badge ${data.status === 'Accepted' ? '' : 'error'}`;
                    metadataBar.style.display = 'flex';
                }
            } catch (err) {
                resultDisplay.innerHTML = `<pre class="text-danger">Failed to connect to backend: ${err.message}</pre>`;
            } finally {
                runBtn.classList.remove('running');
            }
        };

        document.getElementById('clear-output').onclick = () => {
            resultDisplay.innerHTML = '<p class="placeholder-text">Click "Run Code" to see results.</p>';
            metadataBar.style.display = 'none';
        };

        // Hotkeys
        document.addEventListener('keydown', (e) => {
            if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
                runBtn.click();
            }
        });
    });
</script>
{% endblock %}